name: Generate Posts

on:
  push:
    branches: [main]
    paths:
      - "pages/**"
  pull_request:
    branches: [main]
    paths:
      - "pages/**"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  generate-posts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate posts.json
      run: |
        echo "ğŸ“š ê²Œì‹œê¸€ ë©”íƒ€ë°ì´í„° ìƒì„± ì¤‘..."
        
        # posts.json ì´ˆê¸°í™”
        echo '{"posts":[]}' > posts.json
        
        # pages í´ë” í™•ì¸
        if [ ! -d "pages" ]; then
          echo "âš ï¸ pages í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 0
        fi
        
        # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ê°œìˆ˜ í™•ì¸
        md_files=$(find pages -name "*.md" | wc -l)
        echo "ğŸ“„ $md_filesê°œì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ë°œê²¬"
        
        if [ $md_files -eq 0 ]; then
          echo "âš ï¸ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 0
        fi
        
        # posts.json ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
        cat > generate_posts.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        function parseFrontMatter(content) {
          const frontMatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
          const match = content.match(frontMatterRegex);
          
          if (!match) {
            return { frontMatter: {}, body: content };
          }
          
          const frontMatterText = match[1];
          const body = match[2];
          const frontMatter = {};
          
          const lines = frontMatterText.split('\n');
          for (const line of lines) {
            const trimmedLine = line.trim();
            if (!trimmedLine || trimmedLine.startsWith('#')) continue;
            
            const colonIndex = trimmedLine.indexOf(':');
            if (colonIndex === -1) continue;
            
            const key = trimmedLine.substring(0, colonIndex).trim();
            let value = trimmedLine.substring(colonIndex + 1).trim();
            
            // ë”°ì˜´í‘œ ì œê±°
            if ((value.startsWith('"') && value.endsWith('"')) || 
                (value.startsWith("'") && value.endsWith("'"))) {
              value = value.slice(1, -1);
            }
            
            // ë°°ì—´ íŒŒì‹±
            if (value.startsWith('[') && value.endsWith(']')) {
              const arrayContent = value.slice(1, -1);
              frontMatter[key] = arrayContent.split(',').map(item => 
                item.trim().replace(/^['"]|['"]$/g, '')
              );
            } else {
              frontMatter[key] = value;
            }
          }
          
          return { frontMatter, body };
        }
        
        function generatePosts() {
          const posts = [];
          const pagesDir = 'pages';
          
          try {
            const files = fs.readdirSync(pagesDir).filter(file => file.endsWith('.md'));
            
            console.log(`ğŸ“„ ${files.length}ê°œì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ì²˜ë¦¬ ì¤‘...`);
            
            files.forEach(file => {
              try {
                const filePath = path.join(pagesDir, file);
                const content = fs.readFileSync(filePath, 'utf8');
                
                const { frontMatter, body } = parseFrontMatter(content);
                
                const post = {
                  file: file,
                  title: frontMatter.title || 'ì œëª© ì—†ìŒ',
                  date: frontMatter.date || new Date().toISOString().split('T')[0],
                  description: frontMatter.description || '',
                  tags: frontMatter.tags || [],
                  category: frontMatter.category || '',
                  content: body.substring(0, 200).replace(/\n/g, ' ') + '...'
                };
                
                posts.push(post);
                console.log(`âœ… ${file} ì²˜ë¦¬ ì™„ë£Œ`);
              } catch (error) {
                console.error(`âŒ ${file} ì²˜ë¦¬ ì‹¤íŒ¨:`, error.message);
              }
            });
            
            // ë‚ ì§œ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            posts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // posts.json ìƒì„±
            const result = { posts: posts };
            fs.writeFileSync('posts.json', JSON.stringify(result, null, 2));
            
            console.log(`ğŸ‰ posts.json ìƒì„± ì™„ë£Œ: ${posts.length}ê°œ ê²Œì‹œê¸€`);
          } catch (error) {
            console.error('âŒ posts.json ìƒì„± ì‹¤íŒ¨:', error.message);
            process.exit(1);
          }
        }
        
        generatePosts();
        EOF
        
        # Node.js ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        node generate_posts.js
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -f posts.json ]; then
          if git diff --quiet posts.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ posts.jsonì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ posts.jsonì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âŒ posts.json íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add posts.json
        git commit -m "ğŸ¤– posts.json ìë™ ì—…ë°ì´íŠ¸ [skip ci]"
        git push
        
    - name: Upload posts.json as artifact
      uses: actions/upload-artifact@v4
      with:
        name: posts-json
        path: posts.json
        retention-days: 30